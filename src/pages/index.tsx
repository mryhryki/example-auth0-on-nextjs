import Head from 'next/head'
import Image from 'next/image'
import {Inter} from 'next/font/google'
import styles from '@/styles/Home.module.css'
import {UserProfile, useUser} from "@auth0/nextjs-auth0/client";
import Link from "next/link";
import {getAccessToken, getSession, withPageAuthRequired} from "@auth0/nextjs-auth0";
import {GetServerSidePropsContext} from "next";
import {useFetchTest} from "@/hooks/useFetchTest";
import {useElapsedSec} from "@/hooks/useElapsedSec";

const inter = Inter({subsets: ['latin']})

export default function Home() {
  const {user, error, isLoading} = useUser()
  const {fetchTest, testResults, lastRequestUnixTime} = useFetchTest()
  const elapsedSec = useElapsedSec(lastRequestUnixTime)

  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="icon" href="/favicon.ico"/>
      </Head>
      <main className={styles.main}>
        <header className={styles.header}>
          <span className={styles.userName}>{user?.email ?? '(Not logged in)'}</span>
          {user != null ? (
            <Link href="/api/auth/logout">Logout</Link>
          ) : (
            <Link href="/api/auth/login">Login</Link>
          )}
        </header>

        <div className={styles.content}>
          <div>
            <button onClick={fetchTest}>Fetch Test</button>
            <span>(Elapsed: {Math.floor(elapsedSec / 60)}:{(elapsedSec % 60).toString(10).padStart(2, '0')})</span>
          </div>
          <div>
            <pre>{JSON.stringify(testResults, null, 2)}</pre>
          </div>
        </div>
      </main>
    </>
  )
}

export const getServerSideProps = withPageAuthRequired()
